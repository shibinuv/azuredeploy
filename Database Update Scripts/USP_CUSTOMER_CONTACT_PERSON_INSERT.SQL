GO
/****** Object:  StoredProcedure [dbo].[USP_CUSTOMER_CONTACT_PERSON_INSERT]    Script Date: 21/04/2016 11:14:52 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


IF NOT EXISTS (
	SELECT * 
	FROM sys.objects 
	WHERE type = 'P' AND name = 'USP_CUSTOMER_CONTACT_PERSON_INSERT'
	)
	BEGIN
		EXEC('CREATE PROCEDURE [dbo].[USP_CUSTOMER_CONTACT_PERSON_INSERT] 
			  AS 
			  BEGIN 
				  SET NOCOUNT ON; 
			  END'
		)
	END

IF NOT EXISTS(
	SELECT *
    FROM   INFORMATION_SCHEMA.TABLES
    WHERE  TABLE_NAME = 'TBL_MAS_CUSTOMER_CONTACT_PERSON'
           AND TABLE_SCHEMA = 'dbo'
	)
BEGIN
	CREATE TABLE [dbo].[TBL_MAS_CUSTOMER_CONTACT_PERSON](
		[ID_CP] [int] IDENTITY(1,1) NOT NULL,
		[CP_CUSTOMER_ID] [varchar](10) NOT NULL,
		[CP_FIRST_NAME] [varchar](50) NOT NULL,
		[CP_MIDDLE_NAME] [varchar](50) NULL,
		[CP_LAST_NAME] [varchar](50) NULL,
		[CP_PERM_ADD] [varchar](150) NULL,
		[CP_VISIT_ADD] [varchar](150) NULL,
		[CP_ZIP_CODE] [varchar](50) NULL,
		[CP_ZIP_CITY] [varchar](50) NULL,
		[CP_EMAIL] [varchar](200) NULL,
		[CP_PHONE_PRIVATE] [int] NULL,
		[CP_PHONE_MOBILE] [int] NULL,
		[CP_PHONE_FAX] [int] NULL,
		[CP_PHONE_WORK] [int] NULL,
		[CP_BIRTH_DATE] [date] NULL,
		[CP_ID_TITLE] [int] NULL,
		[CP_ID_FUNCTION] [int] NULL,
		[CP_CONTACT] [bit] NULL,
		[CP_CAR_USER] [bit] NULL,
		[CP_EMAIL_REF] [bit] NULL,
		[CP_NOTES] [text] NULL,
		[CREATED_BY] [varchar](15) NULL,
		[DT_CREATED] [datetime] NULL,
		[MODIFIED_BY] [varchar](15) NULL,
		[DT_MODIFIED] [datetime] NULL,
		PRIMARY KEY ([ID_CP])
	) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
	ALTER TABLE TBL_MAS_CUSTOMER_CONTACT_PERSON 
	ADD CONSTRAINT FK_CONTACT_PERSON_CUSTOMER FOREIGN KEY ([CP_CUSTOMER_ID]) 
		REFERENCES [TBL_MAS_CUSTOMER] ([ID_CUSTOMER]) 
		ON DELETE CASCADE
		ON UPDATE CASCADE
	;
END

IF NOT EXISTS(
	SELECT *
    FROM   INFORMATION_SCHEMA.TABLES
    WHERE  TABLE_NAME = 'TBL_MAS_CUSTOMER_CONTACT_PERSON_FUNCTION'
           AND TABLE_SCHEMA = 'dbo'
	)
BEGIN
	CREATE TABLE [dbo].[TBL_MAS_CUSTOMER_CONTACT_PERSON_FUNCTION](
		[ID_CP_FUNCTION] [int] IDENTITY(1,1) NOT NULL,
		[FUNCTION_CODE] [varchar](10) NOT NULL,
		[FUNCTION_DESCRIPTION] [varchar](10) NOT NULL,
		[CREATED_BY] [varchar](15) NULL,
		[DT_CREATED] [datetime] NULL,
		[MODIFIED_BY] [varchar](15) NULL,
		[DT_MODIFIED] [datetime] NULL,
		PRIMARY KEY ([ID_CP_FUNCTION])
	) ON [PRIMARY]
	ALTER TABLE TBL_MAS_CUSTOMER_CONTACT_PERSON 
	ADD CONSTRAINT FK_CONTACT_PERSON_FUNCTION FOREIGN KEY ([CP_ID_FUNCTION]) 
		REFERENCES [TBL_MAS_CUSTOMER_CONTACT_PERSON_FUNCTION] ([ID_CP_FUNCTION]) 
		ON DELETE CASCADE
		ON UPDATE CASCADE
	;
END

IF NOT EXISTS(
	SELECT *
    FROM   INFORMATION_SCHEMA.TABLES
    WHERE  TABLE_NAME = 'TBL_MAS_CUSTOMER_CONTACT_PERSON_TITLE'
           AND TABLE_SCHEMA = 'dbo'
	)
BEGIN
	CREATE TABLE [dbo].[TBL_MAS_CUSTOMER_CONTACT_PERSON_TITLE](
		[ID_CP_TITLE] [int] IDENTITY(1,1) NOT NULL,
		[TITLE_CODE] [varchar](10) NOT NULL,
		[TITLE_DESCRIPTION] [varchar](10) NOT NULL,
		[CREATED_BY] [varchar](15) NULL,
		[DT_CREATED] [datetime] NULL,
		[MODIFIED_BY] [varchar](15) NULL,
		[DT_MODIFIED] [datetime] NULL
		PRIMARY KEY ([ID_CP_TITLE])
	) ON [PRIMARY]
	ALTER TABLE TBL_MAS_CUSTOMER_CONTACT_PERSON 
	ADD CONSTRAINT FK_CONTACT_PERSON_TITLE FOREIGN KEY ([CP_ID_TITLE]) 
		REFERENCES TBL_MAS_CUSTOMER_CONTACT_PERSON_TITLE ([ID_CP_TITLE]) 
		ON DELETE CASCADE
		ON UPDATE CASCADE
	;
END

GO

-- =============================================
-- Author:		Thomas Won Nyheim (TWN)
-- Create date: 2016/03/04
-- Description:	Adds or updates contact persons for set customer
-- =============================================

ALTER PROCEDURE [dbo].USP_CUSTOMER_CONTACT_PERSON_INSERT (
	@ID_CP				INT = NULL,
	@CP_CUSTOMER_ID		VARCHAR(10),
	@CP_FIRST_NAME		VARCHAR(50),
	@CP_MIDDLE_NAME		VARCHAR(50) = NULL,
	@CP_LAST_NAME		VARCHAR(50),
	@CP_PERM_ADD		VARCHAR(150) = NULL,
	@CP_VISIT_ADD		VARCHAR(150) = NULL,
	@CP_ZIP_CODE		VARCHAR(50) = NULL,
	@CP_ZIP_CITY		VARCHAR(50) = NULL,
	@CP_EMAIL			VARCHAR(200) = NULL,
	@CP_PHONE_PRIVATE	INT = NULL,
	@CP_PHONE_MOBILE	INT = NULL,
	@CP_PHONE_FAX		INT = NULL,
	@CP_PHONE_WORK		INT = NULL,
	@CP_BIRTH_DATE		DATE = NULL,
	@CP_ID_TITLE		INT = NULL,
	@CP_ID_FUNCTION		INT = NULL,
	@CP_CONTACT			BIT = NULL,
	@CP_CAR_USER		BIT = NULL,
	@CP_EMAIL_REF		BIT = NULL,
	@CP_NOTES			TEXT = NULL,
	@CONT_USER			VARCHAR(25), -- USER WHO EDITS OR UPDATES THE CONTACT INFORMATION
	@RETVAL				VARCHAR(10) OUTPUT
)
AS
DECLARE @OK BIT
SET @OK = 1
IF(@CP_FIRST_NAME = '' OR @CP_LAST_NAME = '')
	BEGIN
		SET @OK = 0
	END
IF(@ID_CP IS NULL AND @OK = 1)
	BEGIN
		INSERT INTO [dbo].[TBL_MAS_CUSTOMER_CONTACT_PERSON]
				   ([CP_CUSTOMER_ID]
				   ,[CP_FIRST_NAME]
				   ,[CP_MIDDLE_NAME]
				   ,[CP_LAST_NAME]
				   ,[CP_PERM_ADD]
				   ,[CP_VISIT_ADD]
				   ,[CP_ZIP_CODE]
				   ,[CP_ZIP_CITY]
				   ,[CP_EMAIL]
				   ,[CP_PHONE_PRIVATE]
				   ,[CP_PHONE_MOBILE]
				   ,[CP_PHONE_FAX]
				   ,[CP_PHONE_WORK]
				   ,[CP_BIRTH_DATE]
				   ,[CP_ID_TITLE]
				   ,[CP_ID_FUNCTION]
				   ,[CP_CONTACT]
				   ,[CP_CAR_USER]
				   ,[CP_EMAIL_REF]
				   ,[CP_NOTES]
				   ,[CREATED_BY]
				   ,[DT_CREATED])
			 VALUES
				(@CP_CUSTOMER_ID
				,@CP_FIRST_NAME
				,@CP_MIDDLE_NAME
				,@CP_LAST_NAME
				,@CP_PERM_ADD
				,@CP_VISIT_ADD
				,@CP_ZIP_CODE
				,@CP_ZIP_CITY
				,@CP_EMAIL
				,@CP_PHONE_PRIVATE
				,@CP_PHONE_MOBILE
				,@CP_PHONE_FAX
				,@CP_PHONE_WORK
				,@CP_BIRTH_DATE
				,@CP_ID_TITLE
				,@CP_ID_FUNCTION
				,@CP_CONTACT
				,@CP_CAR_USER
				,@CP_EMAIL_REF
				,@CP_NOTES
				,@CONT_USER
				,GETDATE())
		SET @RETVAL = 'INSFLG'
	END
ELSE IF (@OK = 1)
	BEGIN
		UPDATE [dbo].[TBL_MAS_CUSTOMER_CONTACT_PERSON]
		   SET [CP_FIRST_NAME] = @CP_FIRST_NAME
			  ,[CP_MIDDLE_NAME] = @CP_MIDDLE_NAME
			  ,[CP_LAST_NAME] = @CP_LAST_NAME
			  ,[CP_PERM_ADD] = @CP_PERM_ADD
			  ,[CP_VISIT_ADD] = @CP_VISIT_ADD
			  ,[CP_ZIP_CODE] = @CP_ZIP_CODE
			  ,[CP_ZIP_CITY] = @CP_ZIP_CITY
			  ,[CP_EMAIL] = @CP_EMAIL
			  ,[CP_PHONE_PRIVATE] = @CP_PHONE_PRIVATE
			  ,[CP_PHONE_MOBILE] = @CP_PHONE_MOBILE
			  ,[CP_PHONE_FAX] = @CP_PHONE_FAX
			  ,[CP_PHONE_WORK] = @CP_PHONE_WORK
			  ,[CP_BIRTH_DATE] = @CP_BIRTH_DATE
			  ,[CP_ID_TITLE] = @CP_ID_TITLE
			  ,[CP_ID_FUNCTION] = @CP_ID_FUNCTION
			  ,[CP_CONTACT] = @CP_CONTACT
			  ,[CP_CAR_USER] = @CP_CAR_USER
			  ,[CP_EMAIL_REF] = @CP_EMAIL_REF
			  ,[CP_NOTES] = @CP_NOTES
			  ,[MODIFIED_BY] = @CONT_USER
			  ,[DT_MODIFIED] = GETDATE()
		 WHERE ID_CP = @ID_CP
		 SET @RETVAL = 'UPDFLG'
	END
ELSE
	BEGIN
		SET @RETVAL = 'ERRFLG'
	END

PRINT @RETVAL


