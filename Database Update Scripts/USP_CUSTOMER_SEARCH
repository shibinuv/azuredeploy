/****** Object:  StoredProcedure [dbo].[USP_CUSTOMER_SEARCH]    Script Date: 10/6/2015 11:22:27 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Thomas Won Nyheim (TWN)
-- Create date: 2015/10/6
-- Description:	Fetches customers for dashboard search
-- =============================================
IF NOT EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'USP_CUSTOMER_SEARCH')
   exec('CREATE PROCEDURE [dbo].[USP_CUSTOMER_SEARCH] AS BEGIN SET NOCOUNT ON; END')
GO

ALTER PROCEDURE [dbo].[USP_CUSTOMER_SEARCH] 
@ID_SEARCH VARCHAR(255)
AS
DECLARE @string as varchar(255) = @ID_SEARCH
DECLARE @string_cut as varchar (255) = REPLACE(@string, ' ', ';')
DECLARE @parsed_query as nvarchar(2000)
DECLARE @i int = 1
DECLARE @query_col as nvarchar(1000) = 'ISNULL(ID_CUSTOMER,'''') + ISNULL(CUST_NAME,'''') + ISNULL(CUST_FIRST_NAME,'''') + ISNULL(CUST_MIDDLE_NAME,'''') + ISNULL(CUST_VISIT_ADDRESS,'''') + ISNULL(CUST_PHONE_OFF,'''') + ISNULL(CUST_PHONE_HOME,'''') + ISNULL(CUST_PHONE_MOBILE,'''') + ISNULL(ZIP_CITY,'''')' -- SEARCHABLE COLUMNS
SELECT * INTO #tmp_patterns FROM dbo.ParseValues(@string_cut, ';')


DECLARE @stringCount as int = (SELECT COUNT(*) FROM #tmp_patterns)

SELECT TOP 0
	ID_CUSTOMER, CUST_NAME, CUST_GEN_TYPE, ID_CUST_GROUP, CUST_CONTACT_PERSON, ID_CUST_REG_CD, ID_CUST_PC_CODE, 
    ID_CUST_DISC_CD, CUST_SSN_NO, CUST_DRIV_LICNO, CUST_PHONE_OFF, CUST_PHONE_HOME, CUST_PHONE_MOBILE, CUST_FAX, CUST_ID_EMAIL, 
    CUST_REMARKS, CUST_PERM_ADD1, CUST_PERM_ADD2, ID_CUST_PERM_ZIPCODE, CUST_BILL_ADD1, CUST_BILL_ADD2, ID_CUST_BILL_ZIPCODE, 
    CUST_ACCOUNT_NO, ID_CUST_PAY_TYPE, ID_CUST_CURRENCY, CUST_CREDIT_LIMIT, CUST_UNUTIL_CREDIT, ID_CUST_WARN, ID_CUST_PAY_TERM, 
    FLG_CUST_INACTIVE, FLG_CUST_ADV, FLG_CUST_FACTORING, FLG_CUST_BATCHINV, FLG_CUST_NOCREDIT, TMC.CREATED_BY, TMC.DT_CREATED, TMC.MODIFIED_BY, 
    TMC.DT_MODIFIED, CUST_BALANCE, IsSameAddress, IsExported, CUST_HOURLYPRICE, FLG_COSTPRICE, COSTPRICE, CUST_GARAGEMAT, CUST_SUB, CUST_DEP, 
    FLG_CUST_IGNOREINV, FLG_INV_EMAIL, CUST_INV_EMAIL, CUST_FIRST_NAME, CUST_MIDDLE_NAME, CUST_LAST_NAME, CUST_COUNTRY, 
    CUST_VISIT_ADDRESS, CUST_MAIL_ADDRESS, CUST_PHONE_ALT, CUST_HOMEPAGE, FLG_EINVOICE, FLG_ORDCONF_EMAIL, FLG_NO_SMS, 
    FLG_NO_MARKETING, FLG_NO_HUMANEORG, FLG_NO_PHONESALE, FLG_PRIVATE_COMP, FLG_NO_EMAIL,ZIP_CITY
	INTO #tmp_res 
FROM 
	TBL_MAS_CUSTOMER TMC
	inner join
		TBL_MAS_ZIPCODE ZIP
		on TMC.ID_CUST_PERM_ZIPCODE = zip.ZIP_ZIPCODE

WHILE @i <= @stringCount
BEGIN
	DECLARE @value as varchar(150) = (SELECT Val FROM dbo.ParseValues(@string_cut, ';') WHERE ID = @i)
	INSERT INTO 
		#tmp_res 
	SELECT 
		ID_CUSTOMER, CUST_NAME, CUST_GEN_TYPE, ID_CUST_GROUP, CUST_CONTACT_PERSON, ID_CUST_REG_CD, ID_CUST_PC_CODE, 
        ID_CUST_DISC_CD, CUST_SSN_NO, CUST_DRIV_LICNO, CUST_PHONE_OFF, CUST_PHONE_HOME, CUST_PHONE_MOBILE, CUST_FAX, CUST_ID_EMAIL, 
        CUST_REMARKS, CUST_PERM_ADD1, CUST_PERM_ADD2, ID_CUST_PERM_ZIPCODE, CUST_BILL_ADD1, CUST_BILL_ADD2, ID_CUST_BILL_ZIPCODE, 
        CUST_ACCOUNT_NO, ID_CUST_PAY_TYPE, ID_CUST_CURRENCY, CUST_CREDIT_LIMIT, CUST_UNUTIL_CREDIT, ID_CUST_WARN, ID_CUST_PAY_TERM, 
        FLG_CUST_INACTIVE, FLG_CUST_ADV, FLG_CUST_FACTORING, FLG_CUST_BATCHINV, FLG_CUST_NOCREDIT, TMC.CREATED_BY, TMC.DT_CREATED, TMC.MODIFIED_BY, 
        TMC.DT_MODIFIED, CUST_BALANCE, IsSameAddress, IsExported, CUST_HOURLYPRICE, FLG_COSTPRICE, COSTPRICE, CUST_GARAGEMAT, CUST_SUB, CUST_DEP, 
        FLG_CUST_IGNOREINV, FLG_INV_EMAIL, CUST_INV_EMAIL, CUST_FIRST_NAME, CUST_MIDDLE_NAME, CUST_LAST_NAME, CUST_COUNTRY, 
        CUST_VISIT_ADDRESS, CUST_MAIL_ADDRESS, CUST_PHONE_ALT, CUST_HOMEPAGE, FLG_EINVOICE, FLG_ORDCONF_EMAIL, FLG_NO_SMS, 
        FLG_NO_MARKETING, FLG_NO_HUMANEORG, FLG_NO_PHONESALE, FLG_PRIVATE_COMP, FLG_NO_EMAIL,ZIP_CITY
	FROM 
		TBL_MAS_CUSTOMER TMC
		inner join
		TBL_MAS_ZIPCODE ZIP
		on TMC.ID_CUST_PERM_ZIPCODE = zip.ZIP_ZIPCODE
	WHERE 
		ISNULL(ID_CUSTOMER,'') + ISNULL(CUST_NAME,'') + ISNULL(CUST_FIRST_NAME,'') + ISNULL(CUST_MIDDLE_NAME,'') + ISNULL(CUST_VISIT_ADDRESS,'') + ISNULL(CUST_PHONE_OFF,'') + ISNULL(CUST_PHONE_HOME,'') + ISNULL(CUST_PHONE_MOBILE,'') + ISNULL(ZIP_CITY,'') LIKE '%' + @value + '%'
	IF @i = 1 
		SET @parsed_query = CONCAT(@parsed_query,'SELECT DISTINCT * FROM #tmp_res WHERE ', @query_col, ' LIKE ''%', @value, '%'' ') -- ADDS BEGINNING STATEMENT
	ELSE
		SET @parsed_query = CONCAT(@parsed_query, 'AND ', @query_col, ' LIKE ''%', @value, '%'' ') -- ALL FOLLOWING STATEMENTS POST SELECT AND WHERE

	SET @i = @i + 1
END

-- SELECT * FROM #tmp_res ORDER BY VEH_REG_NO ASC -- Matches all results from all queries
EXECUTE sp_executesql @parsed_query -- Parsed dynamic query, must match all search queries in single row

DROP TABLE #tmp_res
DROP TABLE #tmp_patterns